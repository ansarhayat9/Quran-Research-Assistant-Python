<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran Research Assistant</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        :root { --primary:#00c2a8; --primary-dark:#00a08a; --accent:#ffd166; --dark-bg:#0e141b; --dark-card:#16202a; --dark-border:#243241; --text-primary:#e6edf3; --text-secondary:#9db1c4; --success:#10b981; --danger:#ef4444; --sidebar-width:280px; --transition:all .25s ease; --glow:0 0 30px rgba(0,194,168,.25); }
        body { background: radial-gradient(1200px 800px at 20% 0%, rgba(0,194,168,.08), transparent), radial-gradient(1200px 800px at 80% 20%, rgba(255,209,102,.06), transparent), var(--dark-bg); color: var(--text-primary); display: flex; min-height: 100vh; overflow-x: hidden; }
        .sidebar { width: var(--sidebar-width); background: linear-gradient(180deg, #0b1117, #0b1318); height: 100vh; position: fixed; left: 0; top: 0; padding: 25px 0; border-right: 1px solid var(--dark-border); display: flex; flex-direction: column; z-index: 100; }
        .logo { display: flex; align-items: center; gap: 14px; padding: 0 24px 24px; border-bottom: 1px solid var(--dark-border); margin-bottom: 26px; }
        .logo-icon { background: radial-gradient(120px 80px at 30% 20%, var(--accent), var(--primary)); width: 46px; height: 46px; border-radius: 12px; display: grid; place-items: center; color: #0b1117; font-weight: 900; box-shadow: var(--glow); }
        .logo-text { font-size: 1.2rem; font-weight: 800; letter-spacing: .3px; }
        .sidebar-menu { padding: 0 14px; flex-grow: 1; }
        .menu-item { display: flex; align-items: center; gap: 14px; padding: 12px 16px; border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: var(--transition); color: var(--text-secondary); }
        .menu-item:hover, .menu-item.active { background: rgba(0,194,168,.12); color: var(--primary); }
        .menu-item i { width: 22px; text-align: center; }
        .sidebar-footer { padding: 16px 24px 0; border-top: 1px solid var(--dark-border); color: var(--text-secondary); font-size: .85rem; }
        .main-content { flex: 1; margin-left: var(--sidebar-width); padding: 30px; position: relative; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 22px; position: relative; }
        .threeDText { font-size: 2.2rem; font-weight: 900; background: linear-gradient(90deg, var(--accent), var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 3px 0 rgba(0,0,0,.25), 0 10px 20px rgba(0,0,0,.35); letter-spacing: .6px; }
        .user-controls { display: flex; flex-direction: row; align-items: center; gap: 12px; }
        .btn { background: var(--dark-card); border: 1px solid var(--dark-border); color: var(--text-primary); padding: 10px 14px; border-radius: 10px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; transition: var(--transition); box-shadow: 0 2px 10px rgba(0,0,0,.2); min-width: 140px; height: 40px; }
        select.btn { appearance: none; -webkit-appearance: none; -moz-appearance: none; padding-right: 28px; position: relative; background-image: linear-gradient(45deg, transparent 50%, var(--text-secondary) 50%), linear-gradient(135deg, var(--text-secondary) 50%, transparent 50%); background-position: right 12px top 16px, right 6px top 16px; background-size: 6px 6px; background-repeat: no-repeat; }
        .btn:hover { background: rgba(0,194,168,.14); border-color: var(--primary); color: var(--text-primary); box-shadow: 0 0 0 1px var(--primary), 0 8px 22px rgba(0,194,168,.18); }
        .card { background: rgba(22,32,42,.9); border-radius: 16px; border: 1px solid var(--dark-border); overflow: hidden; box-shadow: 0 10px 25px rgba(0,0,0,.25); backdrop-filter: saturate(1.1) blur(4px); transition: border-color .2s ease, box-shadow .2s ease; }
        .card:hover { border-color: var(--primary); box-shadow: 0 10px 25px rgba(0,0,0,.25), 0 0 0 1px var(--primary), var(--glow); }
        .card-header { padding: 18px 22px; border-bottom: 1px solid var(--dark-border); display: flex; justify-content: space-between; align-items: center; }
        .card-body { padding: 22px; }
        .instructions { background: rgba(22,32,42,.7); border-left: 4px solid var(--primary); padding: 16px 18px; border-radius: 12px; margin-bottom: 18px; display: flex; gap: 14px; }
        label { display: flex; align-items: center; gap: 10px; font-weight: 700; font-size: 1rem; margin-bottom: 10px; }
        textarea#questionInput { width: 100%; padding: 16px; border: 1px solid var(--dark-border); border-radius: 12px; font-size: 16px; min-height: 130px; resize: vertical; transition: var(--transition); background: rgba(22,32,42,.6); color: var(--text-primary); }
        textarea#questionInput:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 0 3px rgba(0,194,168,.18); }
        button#askButton { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: #071116; padding: 15px 20px; border: none; border-radius: 12px; cursor: pointer; font-size: 1.05rem; font-weight: 800; transition: var(--transition); display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; box-shadow: 0 6px 20px rgba(0,194,168,.25); }
        button#askButton:hover { transform: translateY(-2px); box-shadow: 0 10px 26px rgba(0,194,168,.35); }
        button#askButton:disabled { background: #64748b; color: #c6d0da; cursor: not-allowed; transform: none; box-shadow: none; }
        .output-actions { display:flex; gap:10px; flex-wrap: wrap; }
        .output-container { border-radius: 12px; overflow: hidden; border: 1px solid var(--dark-border); background: rgba(22,32,42,.55); }
        #outputArea { padding: 26px; min-height: 220px; white-space: pre-wrap; word-wrap: break-word; line-height: 1.85; font-size: 17px; max-height: 520px; overflow-y: auto; }
        #outputArea p { background: rgba(255,255,255,.02); border-left: 4px solid var(--primary); padding: 12px 14px; border-radius: 8px; margin: 12px 0; box-shadow: 0 4px 14px rgba(0,0,0,.18); }
        #outputArea h3, #outputArea h4 { margin: 18px 0 8px; font-weight: 800; letter-spacing: .3px; }
        #outputArea h3 { font-size: 1.1rem; color: var(--accent); }
        #outputArea h4 { font-size: 1rem; color: var(--text-primary); opacity: .9; }
        #outputArea ul { padding-left: 20px; margin: 10px 0; }
        #outputArea li { margin: 6px 0; }
        #outputArea a { color: var(--accent); text-decoration: none; }
        .loading-indicator { text-align: center; padding: 24px; display: none; }
        .spinner { width: 46px; height: 46px; border: 5px solid rgba(0,194,168,.18); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 14px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .error-message { color: var(--danger); background: rgba(239,68,68,.08); padding: 16px; border-radius: 12px; margin: 12px 0; border-left: 4px solid var(--danger); font-weight: 600; display: flex; gap: 10px; align-items: center; }
        .stat-row { display: grid; grid-template-columns: repeat(3, minmax(160px, 1fr)); gap: 16px; }
        .stat-card { background: rgba(22,32,42,.7); border-radius: 12px; padding: 16px; border: 1px solid var(--dark-border); text-align: center; transition: var(--transition); box-shadow: var(--glow); }
        .stat-card:hover { transform: translateY(-2px); border-color: var(--primary); box-shadow: 0 12px 28px rgba(0,0,0,.35), var(--glow); }
        .orb { position: absolute; border-radius: 50%; filter: blur(40px); opacity: .2; pointer-events: none; animation: float 10s ease-in-out infinite alternate; }
        .orb.one { width: 260px; height: 260px; background: var(--primary); top: -40px; left: 40%; }
        .orb.two { width: 220px; height: 220px; background: var(--accent); top: 60%; right: -60px; animation-duration: 12s; }
        @keyframes float { from { transform: translateY(0px); } to { transform: translateY(-30px); } }
        .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; z-index: 200; }
        .modal { width: min(720px, 92vw); background: var(--dark-card); border: 1px solid var(--dark-border); border-radius: 14px; box-shadow: 0 30px 60px rgba(0,0,0,.45), var(--glow); overflow: hidden; transform: translateY(10px); opacity: 0; transition: var(--transition); }
        .modal.open { transform: translateY(0); opacity: 1; }
        .modal-header { padding: 16px 20px; border-bottom: 1px solid var(--dark-border); display: flex; align-items: center; justify-content: space-between; }
        .modal-body { padding: 18px 20px; }
        .chip-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-top: 12px; }
        .chip { background: rgba(22,32,42,.7); border: 1px solid var(--dark-border); padding: 12px; border-radius: 12px; cursor: pointer; transition: var(--transition); display: flex; align-items: center; gap: 10px; }
        .chip:hover { border-color: var(--primary); transform: translateY(-2px); box-shadow: var(--glow); }
        .swatch { width: 22px; height: 22px; border-radius: 6px; box-shadow: inset 0 0 0 2px rgba(255,255,255,.15); }
        @media (max-width: 1100px) { .dashboard { grid-template-columns: 1fr; } }
        @media (max-width: 768px) { .sidebar{width:70px;overflow:hidden;} .logo-text,.menu-text,.sidebar-footer{display:none;} .main-content{margin-left:70px;padding:20px;} .user-controls{flex-wrap:wrap;} }
        @media (max-width: 480px) { .sidebar{display:none;} .main-content{margin-left:0;} .stat-row{grid-template-columns:1fr;} }
        .hero { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 20px; margin-bottom: 18px; }
        .quran-illu { width: 220px; height: 180px; perspective: 600px; }
        .quran-illu svg { filter: drop-shadow(0 20px 30px rgba(0,0,0,.3)); transform: rotateY(-12deg) rotateX(6deg); }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="logo">
            <div class="logo-icon"><i class="fa-solid fa-book-quran"></i></div>
            <div class="logo-text">Quran Research</div>
        </div>
        <div class="sidebar-menu">
            <div class="menu-item active"><i class="fas fa-home"></i><span class="menu-text">Home</span></div>
            <div class="menu-item" id="examplesBtn"><i class="fas fa-star"></i><span class="menu-text">Examples</span></div>
            <div class="menu-item" id="settingsBtn"><i class="fas fa-gear"></i><span class="menu-text">Settings</span></div>
        </div>
        <div class="sidebar-footer">
            <p>Quran Assistant v1.0</p>
            <p>Powered by Gemini</p>
        </div>
    </div>

    <div class="main-content">
        <div class="orb one"></div>
        <div class="orb two"></div>
        <div class="header">
            <h1 class="threeDText" id="titleTxt">Quran Research Assistant</h1>
            <div class="user-controls">
                <button class="btn" id="toggleExamples"><i class="fas fa-wand-magic-sparkles"></i> <span class="i18n" data-en="Examples" data-ur="مثالیں">Examples</span></button>
                <button class="btn" id="openSettings"><i class="fas fa-sliders"></i> <span class="i18n" data-en="Settings" data-ur="ترتیبات">Settings</span></button>
                <select class="btn" id="langSelect">
                    <option value="en">English</option>
                    <option value="ur">اردو</option>
                </select>
                <button class="btn" id="clearChat"><i class="fas fa-broom"></i> <span class="i18n" data-en="Clear" data-ur="صاف کریں">Clear</span></button>
            </div>
        </div>

        <div class="hero card">
            <div class="card-body">
                <div class="instructions" style="margin-bottom: 12px;">
                    <i class="fas fa-circle-info"></i>
                    <div>
                        <p class="i18n" data-en="Scope: Quran-only questions (surahs, verses, themes, words, structure). For word counts (e.g., 'lie/jhoot'), I’ll include verse references and a verification link." data-ur="دائرہ کار: صرف قرآن سے متعلق سوالات (سورہ، آیات، موضوعات، الفاظ، ساخت)۔ لفظی تعداد کے سوالات کے لیے آیات کے حوالہ جات اور تصدیقی لنک شامل کیے جائیں گے۔">Scope: Quran-only questions…</p>
                        <p class="i18n" data-en="Tip: Try 'How many verses are in the Quran?' or 'Verses about truthfulness'." data-ur="مشورہ: 'قرآن میں کتنی آیات ہیں؟' یا 'سچائی کے بارے میں آیات' جیسے سوالات آزمائیں۔">Tip…</p>
                    </div>
                </div>
                <div class="form-group">
                    <label for="questionInput"><i class="fas fa-keyboard"></i> <span class="i18n" data-en="Your Question" data-ur="آپ کا سوال">Your Question</span></label>
                    <textarea id="questionInput" placeholder="e.g., How many times is mercy mentioned? Show references."></textarea>
                </div>
                <div class="output-actions" style="margin-bottom:10px;">
                    <button class="btn" id="copyCitations"><i class="fas fa-copy"></i> <span class="i18n" data-en="Copy Citations" data-ur="حوالہ جات نقل کریں">Copy Citations</span></button>
                    <button class="btn" id="copyAyat"><i class="fas fa-quote-right"></i> <span class="i18n" data-en="Copy Ayat" data-ur="آیات نقل کریں">Copy Ayat</span></button>
                    <button class="btn" id="copyLinks"><i class="fas fa-link"></i> <span class="i18n" data-en="Copy Links" data-ur="روابط نقل کریں">Copy Links</span></button>
                    <button class="btn" id="copyResponse"><i class="fas fa-file-export"></i> <span class="i18n" data-en="Copy Response" data-ur="جواب نقل کریں">Copy Response</span></button>
                </div>
                <button id="askButton"><i class="fas fa-paper-plane"></i> <span class="i18n" data-en="Ask" data-ur="پوچھیں">Ask</span></button>
            </div>
            <div class="quran-illu">
                <svg width="220" height="180" viewBox="0 0 200 160" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                        <linearGradient id="g1" x1="0" y1="0" x2="1" y2="1">
                            <stop offset="0%" stop-color="var(--accent)"/>
                            <stop offset="100%" stop-color="var(--primary)"/>
                        </linearGradient>
                    </defs>
                    <rect x="40" y="30" rx="8" ry="8" width="120" height="100" fill="#0f1720" stroke="url(#g1)" stroke-width="3"/>
                    <path d="M100 40 L120 50 L100 60 L80 50 Z" fill="url(#g1)"/>
                    <rect x="54" y="54" width="92" height="52" rx="6" fill="#0b1318" stroke="#1f2a36"/>
                    <circle cx="100" cy="80" r="16" fill="none" stroke="url(#g1)" stroke-width="2"/>
                    <path d="M100 64 A16 16 0 0 1 116 80" stroke="url(#g1)" fill="none"/>
                </svg>
            </div>
        </div>

        <div class="card output-section" style="grid-column: span 2;">
            <div class="card-header">
                <h2><i class="fas fa-book-open" style="color: var(--primary);"></i> <span class="i18n" data-en="Answer" data-ur="جواب">Answer</span></h2>
            </div>
            <div class="card-body">
                <div class="loading-indicator" id="loadingIndicator">
                    <div class="spinner"></div>
                    <p class="i18n" data-en="Consulting Quranic references…" data-ur="قرآنی حوالہ جات تلاش کیے جا رہے ہیں…">Consulting…</p>
                </div>
                <div class="output-container"><div id="outputArea"></div></div>
            </div>
        </div>

        <div class="card" id="examplesCard" style="grid-column: span 2;">
            <div class="card-header">
                <h2><i class="fas fa-bolt" style="color: var(--accent);"></i> <span class="i18n" data-en="Quick Examples" data-ur="فوری مثالیں">Quick Examples</span></h2>
            </div>
            <div class="card-body">
                <div class="stat-row" id="examples">
                    <div class="stat-card example">How many verses are in the Quran? Mention variations.</div>
                    <div class="stat-card example">Verses about truthfulness with references</div>
                    <div class="stat-card example">How many times is "mercy" mentioned? Provide key verses</div>
                    <div class="stat-card example">List verses discouraging lying (with Surah:Ayah)</div>
                    <div class="stat-card example">What is An-Nahl 16:90 about? Provide link</div>
                    <div class="stat-card example">Explain the theme of Surah Al-Fatiha briefly</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-backdrop" id="settingsModal">
        <div class="modal" id="settingsPanel">
            <div class="modal-header">
                <h3><i class="fas fa-sliders"></i> <span class="i18n" data-en="Settings" data-ur="ترتیبات">Settings</span></h3>
                <button class="btn" id="closeSettings"><i class="fas fa-xmark"></i> <span class="i18n" data-en="Close" data-ur="بند کریں">Close</span></button>
            </div>
            <div class="modal-body">
                <h4 class="i18n" data-en="Color Themes" data-ur="رنگ کے موضوعات">Color Themes</h4>
                <div class="chip-row" id="themeRow">
                    <div class="chip" data-theme="emerald"><span class="swatch" style="background: linear-gradient(45deg,#00c2a8,#00a08a)"></span> Emerald</div>
                    <div class="chip" data-theme="sapphire"><span class="swatch" style="background: linear-gradient(45deg,#3b82f6,#1d4ed8)"></span> Sapphire</div>
                    <div class="chip" data-theme="amethyst"><span class="swatch" style="background: linear-gradient(45deg,#a78bfa,#7c3aed)"></span> Amethyst</div>
                    <div class="chip" data-theme="sunset"><span class="swatch" style="background: linear-gradient(45deg,#fb7185,#f59e0b)"></span> Sunset</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const questionInput = document.getElementById('questionInput');
        const askButton = document.getElementById('askButton');
        const outputArea = document.getElementById('outputArea');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const examples = document.querySelectorAll('.example');
        const clearBtn = document.getElementById('clearChat');
        const examplesCard = document.getElementById('examplesCard');
        const toggleExamples = document.getElementById('toggleExamples');
        const examplesBtn = document.getElementById('examplesBtn');
        const settingsBtn = document.getElementById('settingsBtn');
        const settingsModal = document.getElementById('settingsModal');
        const settingsPanel = document.getElementById('settingsPanel');
        const closeSettings = document.getElementById('closeSettings');
        const themeRow = document.getElementById('themeRow');
        const langSelect = document.getElementById('langSelect');

        const THEMES = { emerald:{primary:'#00c2a8',primaryDark:'#00a08a',accent:'#ffd166'}, sapphire:{primary:'#3b82f6',primaryDark:'#1d4ed8',accent:'#60a5fa'}, amethyst:{primary:'#a78bfa',primaryDark:'#7c3aed',accent:'#f0abfc'}, sunset:{primary:'#fb7185',primaryDark:'#f97316',accent:'#f59e0b'} };

        function applyTheme(name){ const t = THEMES[name] || THEMES.emerald; const root = document.documentElement; root.style.setProperty('--primary', t.primary); root.style.setProperty('--primary-dark', t.primaryDark); root.style.setProperty('--accent', t.accent); root.style.setProperty('--glow', `0 0 30px ${hexToRgba(t.primary, .25)}`); localStorage.setItem('quran_theme', name); }
        function hexToRgba(hex,a){ const c=hex.replace('#',''); const bigint=parseInt(c,16); const r=(bigint>>16)&255; const g=(bigint>>8)&255; const b=bigint&255; return `rgba(${r}, ${g}, ${b}, ${a})`; }
        (function initTheme(){ const saved=localStorage.getItem('quran_theme'); if(saved && THEMES[saved]) applyTheme(saved); })();

        function applyLang(lang){ document.documentElement.setAttribute('lang', lang==='ur'?'ur':'en'); document.querySelectorAll('.i18n').forEach(el=>{ el.textContent = el.getAttribute(lang==='ur'?'data-ur':'data-en'); }); if(lang==='ur'){ document.getElementById('titleTxt').style.direction='rtl'; outputArea.style.direction='rtl'; questionInput.style.direction='rtl'; } else { document.getElementById('titleTxt').style.direction='ltr'; outputArea.style.direction='ltr'; questionInput.style.direction='ltr'; } localStorage.setItem('quran_lang', lang); }
        (function initLang(){ const saved=localStorage.getItem('quran_lang')||'en'; langSelect.value=saved; applyLang(saved); })();
        langSelect.addEventListener('change', ()=> applyLang(langSelect.value));

        examples.forEach(el=> el.addEventListener('click', ()=>{ questionInput.value = el.textContent.trim(); askButton.click(); }));
        clearBtn.addEventListener('click', ()=>{ outputArea.innerHTML=''; questionInput.value=''; });
        toggleExamples.addEventListener('click', ()=>{ examplesCard.style.display = examplesCard.style.display==='none'?'':'none'; });
        examplesBtn?.addEventListener('click', ()=>{ examplesCard.scrollIntoView({behavior:'smooth'}); });

        settingsBtn.addEventListener('click', openSettingsModal);
        document.getElementById('openSettings').addEventListener('click', openSettingsModal);
        function openSettingsModal(){ settingsModal.style.display='flex'; requestAnimationFrame(()=> settingsPanel.classList.add('open')); }
        function closeSettingsModal(){ settingsPanel.classList.remove('open'); setTimeout(()=> settingsModal.style.display='none',200); }
        closeSettings.addEventListener('click', closeSettingsModal);
        settingsModal.addEventListener('click', (e)=>{ if(e.target===settingsModal) closeSettingsModal(); });

        themeRow.addEventListener('click', (e)=>{ const chip=e.target.closest('.chip'); if(!chip) return; applyTheme(chip.dataset.theme); });

        // Copy helpers
        function copyText(text){ if(!text){ alert('Nothing to copy.'); return; } navigator.clipboard.writeText(text).then(()=> alert('Copied to clipboard!')); }

        // Copy Citations
        document.getElementById('copyCitations').addEventListener('click', ()=>{
            const text = outputArea.innerText || '';
            const refs = new Set();
            const regexes = [ /([A-Za-z\-']+\s+)?(\d{1,3}:\d{1,3})/g, /(Al\-[A-Za-z]+|As\-[A-Za-z]+|An\-[A-Za-z]+)\s+(\d{1,3}:\d{1,3})/g ];
            regexes.forEach(r=>{ let m; while((m=r.exec(text))!==null) refs.add((m[1]?m[1].trim()+' ':'')+m[2]); });
            const list = Array.from(refs).join('\n'); copyText(list);
        });

        // Copy Ayat (paragraphs likely containing ayat or Arabic + translation)
        document.getElementById('copyAyat').addEventListener('click', ()=>{
            const blocks = Array.from(outputArea.querySelectorAll('p, li'));
            const arabicRe = /[\u0600-\u06FF]/;
            const citeRe = /(\d{1,3}:\d{1,3})/;
            const lines = blocks
                .filter(el=> arabicRe.test(el.innerText) || citeRe.test(el.innerText))
                .map(el=> el.innerText.trim())
                .filter(Boolean);
            copyText(lines.join('\n\n'));
        });

        // Copy Links (quran.com etc.)
        document.getElementById('copyLinks').addEventListener('click', ()=>{
            const text = outputArea.innerText || '';
            const linkRe = /(https?:\/\/[^\s)]+)/g;
            const links = new Set();
            let m; while((m=linkRe.exec(text))!==null) links.add(m[1]);
            copyText(Array.from(links).join('\n'));
        });

        // Copy full response
        document.getElementById('copyResponse').addEventListener('click', ()=>{ copyText(outputArea.innerText || ''); });

        async function askBackend(question){ const lang=localStorage.getItem('quran_lang')||'en'; const res=await fetch('/api/ask',{method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({question, lang})}); if(!res.ok){ const err=await res.json().catch(()=>({error:'Unknown error'})); throw new Error(err.error||'Request failed'); } const data=await res.json(); return data.answer||''; }

        function renderMarkdownLike(text){ let safe=text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); safe=safe.replace(/^###\s*(.*)$/gm,'<h3>$1</h3>'); safe=safe.replace(/^##\s*(.*)$/gm,'<h3>$1</h3>'); safe=safe.replace(/^#\s*(.*)$/gm,'<h3>$1</h3>'); safe=safe.replace(/^(?:- |\* )(.*)$/gm,'<li>$1</li>'); safe=safe.replace(/(<li>.*<\/li>\n?)+/g, m=>`<ul>${m}</ul>`); const withCode=safe.replace(/(```[\s\S]*?```)|(`[^`]+`)/g,(m)=>{ if(m.startsWith('```')) return `<pre><code>${m.replace(/```/g,'')}</code></pre>`; return `<code>${m.replace(/`/g,'')}</code>`; }); const blocks=withCode.split(/\n\n+/).filter(Boolean).map(p=> /<h3>|<ul>|<pre>/.test(p)?p:`<p>${p}</p>`).join(''); return blocks; }

        askButton.addEventListener('click', async ()=>{
            const question=questionInput.value.trim(); if(!question){ outputArea.innerHTML='<div class="error-message"><i class="fas fa-exclamation-circle"></i> Please enter a Quran-related question.</div>'; return; }
            outputArea.innerHTML=''; loadingIndicator.style.display='block'; askButton.disabled=true;
            try{ const answer=await askBackend(question); outputArea.innerHTML=renderMarkdownLike(answer);} catch(e){ outputArea.innerHTML=`<div class="error-message"><i class="fas fa-bug"></i> ${e.message}</div>`;} finally{ askButton.disabled=false; loadingIndicator.style.display='none'; }
        });

        questionInput.addEventListener('keypress', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); askButton.click(); } });
    </script>
</body>
</html>
